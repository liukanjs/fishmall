//购物车
//http://www.fish.com/api.php/mall/index/cart_list
//POST['goods_id'] = 100
//POST['key'] = '1234'

$(function () {
    var key = getcookie('key');
    if (key == '') {
        location.href = '/login.html';
    }
    var goods_id = GetQueryString("goods_id");
    var cart = getcookie('cart');
    var isok = false;

    console.log(cart);

    init();

    function init() {

        $.ajax({
            url: ApiUrl + "/mall/index/cart_list",
            type: 'post',
            data: {
                key: key
            },
            timeout: '16000',
            error: function (a, b, c) {
                NProgress.done();
                if (c != "error") {
                    $(window).apptip({
                        msg: c
                    });
                } else {
                    $(window).apptip({
                        msg: "加载失败，请检查网络设置"
                    });
                }
            },
            success: function (result) {
                NProgress.done();
                var data = result.datas;

                var list_empty = data.cart_list.item.length;
                console.log(list_empty);
                if (data == null) {
                    location.href = '/404.html';
                    return;
                }
                if (list_empty == 0) {
                    var html = '<section class="layout"><div class="blank"></div> <div class="text-center"><div class="text-gray"><span class="ticon-cart fz64"></span></div><div class="text-center">您的购物车空空如也，快去逛逛吧~</div></div><div class="blank"></div><div class="padding text-center"><a href="/mall/index.html" class="button button-block bg-main">去首页逛逛</a></div> </section>';

                    $("#main-container").html(html);
                } else {
                    var html = '';
                    isok = true;
                    $.each(data, function (k, v) {
                        html += template.render(k, v);
                    });
                    $("#main-container").html(html);

                    //添加地址
                    $('.add_address').click(function () {
                        addcookie('iscart', 1);
                        location.href = '/user/address_add.html';
                    });
                    //选择地址
                    $('.select_address').click(function () {
                        addcookie('iscart', 1);
                        location.href = '/user/myaddress.html';
                    });

                    //商品数量编辑
                    goods_edit();
                    goods_del();

                    //支付按钮
                    pay();
                }
            }
        });
    }

    function goods_edit() {
        $('.goods_num_edit').click(function () {
            var goods_num = $(this).parent('.wx-cart-num').find('.goods_num').text();
            if ($(this).attr('edit') == 'add') {
                goods_num = parseInt(goods_num) + 1;
            } else {
                if (goods_num > 1) {
                    goods_num = parseInt(goods_num) - 1;
                } else {
                    return
                }
            }

            var goods_id = $(this).parent('.wx-cart-num').attr('goods_id');

            console.log(goods_num);

            $.ajax({
                url: ApiUrl + "/mall/index/cart_add",
                type: 'post',
                data: {
                    key: key,
                    goods_id: goods_id,
                    goods_num: goods_num
                },
                timeout: '16000',
                error: function (a, b, c) {
                    NProgress.done();
                    if (c != "error") {
                        $(window).apptip({
                            msg: c
                        });
                    } else {
                        $(window).apptip({
                            msg: "加载失败，请检查网络设置"
                        });
                    }
                },
                success: function (result) {
                    var data = result.datas;
                    if (result.code == 1) {
                        init();
                    } else {
                        $(window).apptip({
                            msg: result.error
                        })

                    }
                }
            });
        })
    }

    function goods_del() {
        $('.goods_del').click(function () {
            var goods_id = $(this).attr('goods_id');

            console.log(goods_id);

            $.ajax({
                url: ApiUrl + "/mall/index/cart_del",
                type: 'post',
                data: {
                    key: key,
                    goods_id: goods_id
                },
                timeout: '16000',
                error: function (a, b, c) {
                    NProgress.done();
                    if (c != "error") {
                        $(window).apptip({
                            msg: c
                        });
                    } else {
                        $(window).apptip({
                            msg: "加载失败，请检查网络设置"
                        });
                    }
                },
                success: function (result) {
                    var data = result.datas;
                    if (result.code == 1) {
                        $(window).apptip({
                            msg: '删除成功！'
                        })
                        var cart_list_len = $('ul.wx-home-list>li.item').size();
                        if (cart_list_len == 0) {
                            location.href = '/mall/index.html';
                        }

                        init();
                    } else {
                        $(window).apptip({
                            msg: result.error
                        })

                    }
                }
            });
        })
    }

    //提交支付按钮
    function pay() {
        $('#pay').click(function () {
            var ispay = $('#address_check_done').size();
            if (ispay == 1) {
                delCookie('iscart');
                if (is_weixn()) {
                    var data_url = {
                        key: key
                    };
                } else {
                    if ($('#payment_amount').text() != '￥0') {
                        $(window).appalert({
                            msg: "暂不支持wap的微信支付,请关注'狂野钓鱼手游'后支付！"
                        });
                        return;
                    }
                    var data_url = {
                        trade_type: 'WAP',
                        key: key
                    };
                }

                $.ajax({
                    url: ApiUrl + "/mall/index/payment",
                    type: 'post',
                    data: data_url,
                    timeout: '16000',
                    error: function (a, b, c) {
                        NProgress.done();
                        if (c != "error") {
                            $(window).apptip({
                                msg: c
                            });
                        } else {
                            $(window).apptip({
                                msg: "加载失败，请检查网络设置"
                            });
                        }
                    },
                    success: function (result) {
                        var data = result.datas;
                        var is_score_pay = data.score_pay;

                        if (is_score_pay) {
                            $(window).appalert({
                                msg: '支付成功！',
                                cbk: function () {
                                    location.href = "/mall/pay.html";
                                }
                            });
                            return;
                        }

                        if (result.code == 1) {
                            getScript("http://res.wx.qq.com/open/js/jweixin-1.0.0.js", function () {
                                getScript(ApiUrl + '/index/WechatApi/jsapi?url=jsapi&url=' + encodeURIComponent(location.href), function () {

                                    var pay_json = data.paydata;
                                    if (is_weixn()) {
                                        wx.ready(function () {
                                            wx.chooseWXPay({
                                                timestamp: pay_json.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                                                nonceStr: pay_json.nonceStr, // 支付签名随机串，不长于 32 位
                                                package: pay_json.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                                                signType: pay_json.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                                                paySign: pay_json.paySign, // 支付签名
                                                success: function (res) {
                                                    $(window).appalert({
                                                        msg: '支付成功！',
                                                        cbk: function () {
                                                            location.href = "/mall/pay.html";
                                                        }
                                                    });
                                                },
                                                cancel: function (res) {
                                                    $(window).apptip({
                                                        msg: "取消支付"
                                                    });
                                                    location.href = '/user/myorder.html';
                                                },
                                                fail: function (res) {
                                                    $(window).appalert({
                                                        msg: "支付失败,请重试",
                                                        cbk: function () {
                                                            location.href = '/mall/index.html';
                                                        }
                                                    })
                                                }
                                            });
                                        });
                                        wx.error(function (res) {
                                            $(window).appalert({
                                                msg: res.errMsg
                                            });
                                        });
                                    } else {
                                        var wxpay_url = "weixin://wap/pay?appid%3Dwxca1d9e03c5cde04a%26noncestr%3D" + pay_json.nonceStr + "%26package%3DWAP%26" + escape(pay_json.package) + "%26timestamp%3D" + pay_json.timeStamp + "%26sign%3D" + pay_json.paySign;
                                        console.log(wxpay_url);
                                        location.href = wxpay_url;

                                    }
                                });
                            });
                        } else {
                            $(window).apptip({
                                msg: result.error
                            })
                        }
                    }
                });
            } else {
                $(window).appalert({
                    msg: "请添加或选择收货信息！"
                });
            }
        })
    }

    //自动显示回到顶部按钮
    var scrolll_hght;
    var totophtml = '';
    $(window).scroll(function () {
        var dh = $(document).height(); //整个页面文档的高度
        var to_top = $(this).scrollTop(); //滚动条的高度
        var wh = $(this).height(); //窗口的高度；
        scrolll_hght = dh - to_top - wh; //滚动到底部的位置；
        //返回到顶部按钮
        if (to_top > wh) {
            $("#to-top").show();
        } else {
            $("#to-top").hide();
        }
        ;
    });

});