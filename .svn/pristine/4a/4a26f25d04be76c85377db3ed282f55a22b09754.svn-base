//发布活动接口
//http://www.fish.com/api.php/forum/index/active_add
//POST['key'] = '1234'
//POST['title'] = '1234'
//POST['province'] = '20'
//POST['city'] = '234'
//POST['county'] = '2332'
//POST['address'] = '2332'
//POST['img'] = '123.jpg'
//POST['start_time'] = '2015-12-12 00:12:10'
//POST['end_time'] = '2015-12-12 23:12:10'
//POST['fish_name'] = 'bimuyu,gaoji'
//POST['price'] = '200'
//POST['tel'] = '1300000000'
//POST['note'] = '备注'

$(function () {
    var key = getcookie('key');
    if (key == '') {
        location.href = '/login.html';
    }
    //初始化地址列表
    init_citys('province', 'city', 'county', '', '', '');

    $.ajax({
        url: ApiUrl + "/forum/index/nav_type",
        type: 'post',
        data: {ctype: 2, atype: 3},
        timeout: '16000',
        error: function (a, b, c) {
            NProgress.done();
            if (c != "error") {
                $(window).apptip({
                    msg: c
                });
            } else {
                $(window).apptip({
                    msg: "加载失败，请检查网络设置"
                });
            }
        },
        success: function (result) {
            var data = result.datas.class_type;
            if (result.code == 1) {
                $.each(data, function (i, e) {
                    var html = '<option value="' + e.id + '">' + e.name + '</option>';
                    $('#typeid').append(html);
                });
            } else {
                $(window).apptip({
                    msg: "请检查网络设置"
                })
            }
        }
    });

    //时间提取器
    $.datepicker.regional["zh-CN"] = {
        closeText: "关闭",
        prevText: "&#x3c;上月",
        nextText: "下月&#x3e;",
        currentText: "今天",
        monthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
        monthNamesShort: ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二"],
        dayNames: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"],
        dayNamesShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
        dayNamesMin: ["日", "一", "二", "三", "四", "五", "六"],
        weekHeader: "周",
        dateFormat: "yy-mm-dd",
        firstDay: 1,
        isRTL: !1,
        showMonthAfterYear: !0,
        yearSuffix: "年",
    }
    $.datepicker.setDefaults($.datepicker.regional["zh-CN"]);
    $("#start_time").datepicker({
        defaultDate: "+1w",
        changeMonth: true,
        onClose: function (selectedDate) {
            $("#end_time").datepicker("option", "minDate", selectedDate);
        }
    });
    $("#end_time").datepicker({
        defaultDate: "+1w",
        changeMonth: true,
        onClose: function (selectedDate) {
            $("#start_time").datepicker("option", "maxDate", selectedDate);
        }
    });

    //字数监控
    $('#note').keyup(function () {
        var len = $(this).val().length;
        $('#word_len').text(230 - len);
    })

    //表单验证
    $.validator.addMethod("ismobile", function (value, element) {
        var length = value.length;
        var mobiles = /^(1[3|4|5|7|8])+\d{9}?$/;
        return this.optional(element) || (length == 11 && mobiles.test(value));
    }, "请正确填写您的手机号码");
    $.validator.addMethod("chinese", function (value, element) {
        var length = value.length;
        var chinese = /^[\u0391-\uFFE5]+$/;
        return this.optional(element) || (length <= 4 && chinese.test(value));
    }, "请正确填写中文姓名");
	jQuery.validator.addMethod("checkPic", function(value, element) {
		var filepath = $(element).val();
		//获得上传文件名
		var fileArr = filepath.split(",");
		var fileTArr = fileArr[fileArr.length - 1].toLowerCase().split(".");
		var filetype = fileTArr[fileTArr.length - 1];
		console.log(filetype);
		//切割出后缀文件名
		if (filetype === "jpg" || filetype === "gif" || filetype === "jpeg" || filetype === "png") {
			return true;
		} else {
			return false;
		}
	}, "上传图片格式不适合");

    var checkForm = $("#activity-form").validate({
		ignore: [],
        rules: {
            title: {
                required: true,
                minlength: 3
            },
            province: {
                required: true
            },
            city: {
                required: true
            },
            county: {
                required: true
            },
            address: {
                required: true,
                minlength: 5
            },
            start_time: {
                required: true
            },
            end_time: {
                required: true
            },
            img: {
                required: true,
                checkPic: true
            },
            fish_name: {
                required: true,
                minlength: 2
            },
            price: {
                required: true
            },
            tel: {
                required: true,
                ismobile: true
            },
            note: {
                required: true,
                minlength: 5,
                maxlength: 230
            }

        },
        messages: {
            title: {
                required: "请输入活动标题",
                minlength: "标题不得少于3个字"
            },
            province: {
                required: "请选择省"
            },
            city: {
                required: "请选择市"
            },
            county: {
                required: "请选择区县"
            },
            address: {
                required: "请输入详细地址",
                minlength: "地址太短啦"
            },
            img: {
                required: "请上传图片",
                checkPic: "请使用jpg的图片格式"
            },
            start_time: {
                required: "请选择活动日期"
            },
            end_time: {
                required: "请选择活动结束日期"
            },
            fish_name: {
                required: "请输入鱼种",
                minlength: "请输入不少于1个种类的鱼种"
            },
            price: {
                required: "请输入人均价格（元）"
            },
            tel: {
                required: "请输入您的手机号码",
                ismobile: "手机格式有误"
            },
            note: {
                required: "给活动发起人说点什么吧",
                minlength: "字太少啦。。。",
                maxlength: "字太多啦。。。"
            }
        },
        submitHandler: function () {
            activity_add();
        }
    });

    //发起活动
    function activity_add() {
        var typeid = $("select[name=typeid").val();
        var title = $("input[name=title]").val();
        var province = $("select[name=province]").val();
        var city = $("select[name=city]").val();
        var county = $("select[name=county]").val();
        var address = $("input[name=address]").val();
        var img = $("input[name=img]").val();
        var start_time = $("input[name=start_time]").val();
        var end_time = $("input[name=end_time]").val();
        var fish_name = $("input[name=fish_name]").val();
        var price = $("input[name=price]").val();
        var tel = $("input[name=tel]").val();
        var note = $("textarea[name=content]").val();

        $.ajax({
            type: "post",
            url: ApiUrl + "/forum/index/active_add",
            dataType: 'json',
            data: {key:key,ctype:2,atype:3,typeid:typeid,title:title,province:province,city:city,county:county,address:address,img:img,start_time:start_time,end_time:end_time,fish_name:fish_name,price:price,tel:tel,note:note},
            timeout: '10000',
            error: function (a, b, c) {
                if (c != "error") {
                    $(window).apptip({
                        msg: c
                    });
                } else {
                    $(window).apptip({
                        msg: "加载失败，请检查网络设置"
                    });
                }
            },
            success: function (result) {
                var data = result.datas;
                if (result.code == 1) {
                    $(window).appalert({
                        tit: "操作提示",
                        msg: "操作成功，活动已发布！",
                        cbk: function () {
                            window.location.href = WapSiteUrl + '/forum/activity.html';
                        }
                    });
                    return false;
                } else {
                    $(window).apptip({
                        msg: result.error
                    })

                }

            }
        });

    };

    //上传图片
    $('#pic').click(function () {
        // 上传方法
        $.upload({
            // 上传地址
            url: '/api/index/upload',
            // 文件域名字
            fileName: 'filedata',
            // 其他表单数据
            params: {
				up: 1,
                key: key
            },
            // 上传完成后, 返回json, text
            dataType: 'json',
            // 上传之后回调
            onComplate: function (data) {
                $('#imgshow').attr('src', data.datas).show();
                //$('.input-file.input-img').append("<img style='height:100%' src='" + data.datas + "' />");
                $('.add_pic').remove();
                $("input[name=img]").val(data.datas);
            },
            // 上传之前回调,return true表示可继续上传
            onSend: function () {
                return true;
            }
        });
    })

})