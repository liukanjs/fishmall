$(function() {
	var key = getcookie('key');
	var address_id = GetQueryString('address_id');
	if (key == '') {
		location.href = '/login.html';
	}
	var local_address=unescape(getcookie('address'));
	var iscart=getcookie('iscart'); //0：无需跳转cart，1需跳转cart
	
	//初始化地址列表
	init_citys('province', 'city', 'county', '', '', '');

	if (address_id != null) {
		$.ajax({
			type: 'post',
			url: ApiUrl + "/member/index/address_get",
			data: {
				key: key,
				id: address_id
			},
			dataType: 'json',
			timeout: '10000',
			error: function(a, b, c) {
				console.log(b);
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				NProgress.done();
				var data = result.datas.address_info;
				$('input[name=username]').val(data.username);
				$('input[name=telphone]').val(data.telphone);
				init_citys('province', 'city', 'county', data.province, data.city, data.county);
				$('textarea[name=address]').val(data.address);

			}
		});
	} else {
		setTimeout(function() {
			NProgress.done();
		}, 300);
		$('textarea[name=address]').val(local_address);
		
	}

	//表单验证
	$.validator.addMethod("ismobile", function(value, element) {
		var length = value.length;
		var mobiles = /^(1[3|4|5|7|8])+\d{9}?$/;
		return this.optional(element) || (length == 11 && mobiles.test(value));
	}, "请正确填写您的手机号码");
	$.validator.addMethod("phone", function(value, element) {
		var tm = /(^1[3|4|5|7|8]\d{9}$)|(^\d{3,4}-\d{7,8}$)|(^\d{7,8}$)|(^\d{3,4}-\d{7,8}-\d{1,4}$)|(^\d{7,8}-\d{1,4}$)/;
		return this.optional(element) || (tm.test(value));
	}, "格式不对");
	$.validator.addMethod("chinese", function(value, element) {
		var length = value.length;
		var chinese = /^[\u0391-\uFFE5]+$/;
		return this.optional(element) || (length <= 4 && chinese.test(value));
	}, "请正确填写中文姓名");

	var checkForm = $("#address_add").validate({
		ignore: [],
		debug: true,
		rules: {
			username: {
				required: true,
				minlength: 2,
				chinese: true
			},
			telphone: {
				required: true,
				phone: true
			},
			province: {
				required: true
			},
			city: {
				required: true
			},
			county: {
				required: true
			},
			address: {
				required: true,
				minlength: 5,
				maxlength: 50
			}
		},
		messages: {
			username: {
				required: "请输入收件人姓名",
				minlength: "标题不得少于3个字",
				chinese: "请输入中文收件人姓名"
			},
			telphone: {
				required: "请填写收件人联系电话",
				phone: "电话号码格式有误"
			},
			province: {
				required: "请选择省"
			},
			city: {
				required: "请选择市"
			},
			county: {
				required: "请选择区县"
			},
			address: {
				required: "请输入详细地址",
				minlength: "地址太短啦",
				maxlength: "地址太长啦"
			}
		},
		submitHandler: function() {
			add_address();
		}
	});

	function add_address() {

		var username = $('input[name=username]').val();
		var telphone = $('input[name=telphone]').val();
		var province = $('select[name=province]').val();
		var city = $('select[name=city]').val();
		var county = $('select[name=county]').val();
		var address = $('textarea[name=address]').val();

		if (address_id != null) {
			var data_post = {
				id: address_id,
				key: key,
				username: username,
				telphone: telphone,
				province: province,
				city: city,
				county: county,
				address: address
			}
		} else {
			var data_post = {
				key: key,
				username: username,
				telphone: telphone,
				province: province,
				city: city,
				county: county,
				address: address
			}
		}

		$.ajax({
			type: 'post',
			url: ApiUrl + "/member/index/address_add",
			data: data_post,
			dataType: 'json',
			timeout: '10000',
			error: function(a, b, c) {
				console.log(b);
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				var data = result.datas;
				if (iscart == 1) {
						$(window).appalert({
							tit: "操作提示",
							msg: "操作成功",
							cbk: function() {
								location.href = "/mall/cart.html";
							}
						});
				} else {
					if (data == 1) {
						$(window).appalert({
							tit: "操作提示",
							msg: "操作成功",
							cbk: function() {
								window.location.href = WapSiteUrl + '/user/myaddress.html';
							}
						});
						return false;
					} else {
						$(window).apptip({
							msg: "操作失败，请检查网络设置"
						})

					}
				}
			}
		});
	}

});