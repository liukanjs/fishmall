$(function() {
	var key = getcookie('key');

	var isok = false;
	var main = "";
	var loadpage = 0;
	var newDate = new Date();
	var ctype = GetQueryString("ctype");
	var atype = GetQueryString("atype");
	var typeid = GetQueryString("typeid");

	$('#addinfo').click(function() {
		$('.city-list').toggle();
	})


	//初始化导航栏
	$.ajax({
		url: ApiUrl + "/forum/index/nav_type",
		type: 'get',
		timeout: '16000',
		data: {
			ctype: 1
		},
		error: function(a, b, c) {
			NProgress.done();
			if (c != "error") {
				$(window).apptip({
					msg: c
				});
			} else {
				$(window).apptip({
					msg: "加载失败，请检查网络设置"
				});
			}
		},
		success: function(result) {
			NProgress.done();
			var data = result.datas;
			var html = '';
			if (data == null) {
				location.href = '/404.html';
				return;
			}
			isok = true;
			//初始化页面
			var navhtml = template.render("class_type", data);
			$("#navlist").html(navhtml);

			$('.swiper-slide').eq(0).addClass('active');
			var swiper = new Swiper('.swiper-container', {
				pagination: '.swiper-pagination',
				slidesPerView: 6,
				spaceBetween: 0,
				freeMode: true
			});
			if(ctype!=null && atype!=null && typeid!=null){
				init_url(ctype,atype,typeid);
			}else{
				init();
			}
			//导航栏点击事件
			$('.swiper-slide').each(function() {
				$(this).click(function() {
					$("#list_loading").show();
					$('.swiper-slide').removeClass('active');
					$(this).addClass('active');
					var ctype = $(this).attr('ctype');
					var atype = $(this).attr('atype');
					var typeid = $(this).attr('typeid');
					var api = ApiUrl + "/forum/index/index?ctype=" + ctype + "&atype=" + atype + "&typeid=" + typeid + "&curpage=1&page_size=" + pagesize;

					$("input[name=ctype]").val(ctype);
					$("input[name=atype]").val(atype);
					$("input[name=typeid]").val(typeid);
					$("input[name=curpage]").val(1);

					$("#forummain").html("");
					console.log(api);
					$.ajax({
						url: api,
						type: 'post',
						data: {
							key: key
						},
						timeout: '16000',
						error: function(a, b, c) {
							NProgress.done();
							if (c != "error") {
								$(window).apptip({
									msg: c
								});
							} else {
								$(window).apptip({
									msg: "加载失败，请检查网络设置"
								});
							}
						},
						success: function(result) {
							var datas = result.datas;
							var htmls = '';
							if (data == null) {
								$(window).appalert({
									msg: "数据读取错误，请检查网络！"
								})
								return;
							}
							$("input[name=hasmore]").val(result.hasmore);
							$("input[name=page_total]").val(result.page_total);
							isok = true;
							//数据加载判断
							if (atype == 1) {
								var navhtmls = template.render("strategy_list", datas);
							} else if (atype == 2) {
								var navhtmls = template.render("art_list", datas);
							} else if (atype == 3) {
								var navhtmls = template.render("activity_list", datas);
							};
							$("#forummain").html(navhtmls);

							$("#list_loading").hide();
							setTimeout(function() {
								scrollLoad();
							}, 1500)

							//相册
							$('.swipebox').swipebox();
							zambia();
				wh();
						}
					});

				});

			});
		}
	});

	function init() {
		//初始化社区首页内容
		$.ajax({
			url: ApiUrl + "/forum/index",
			type: 'get',
			data: {
				key: key
			},
			timeout: '16000',
			error: function(a, b, c) {
				NProgress.done();
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				NProgress.done();
				var data = result.datas;
				var html = '';
				if (data == null) {
					location.href = '/404.html';
					return;
				}
				isok = true;
				$("input[name=hasmore]").val(result.hasmore);
				$("input[name=page_total]").val(result.page_total);
				//初始化页面
				var navhtml = template.render("strategy_list", data);
				$("#forummain").html(navhtml);

				setTimeout(function() {
					scrollLoad();
				}, 1500);

				//相册
				$('.swipebox').swipebox();
				wh();

				//删帖删文章
				content_del();
				zambia();
			}
		});

	};

	function init_url(ctype,atype,typeid) {
		//链结跳转指定频道
		var api = ApiUrl + "/forum/index/index?ctype=" + ctype + "&atype=" + atype + "&typeid=" + typeid + "&curpage=1&page_size=" + pagesize;

		$("input[name=ctype]").val(ctype);
		$("input[name=atype]").val(atype);
		$("input[name=typeid]").val(typeid);
		$("input[name=curpage]").val(1);

		$.ajax({
			url: api,
			type: 'get',
			data: {
				key: key
			},
			timeout: '16000',
			error: function(a, b, c) {
				NProgress.done();
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				NProgress.done();
				var data = result.datas;
				var html = '';
				if (data == null) {
					location.href = '/404.html';
					return;
				}
				isok = true;
				$("input[name=hasmore]").val(result.hasmore);
				$("input[name=page_total]").val(result.page_total);
				//数据加载判断
				if (atype == 1) {
					var navhtmls = template.render("strategy_list", data);
				} else if (atype == 2) {
					var navhtmls = template.render("art_list", data);
				} else if (atype == 3) {
					var navhtmls = template.render("activity_list", data);
				};
				$("#forummain").html(navhtmls);

				setTimeout(function() {
					scrollLoad();
				}, 1500);

				//相册
				$('.swipebox').swipebox();
				wh();

				//删帖删文章
				content_del();
				zambia();

				$('.swiper-slide').each(function(i,e){
					$(this).removeClass('active');
					var td=$(e).attr('typeid');
					if(td==typeid){
						$(e).addClass('active ');
					}
				})
			}
		});

	};

	//滚动加载
	function scrollLoad() {
		var _hght; //初始化滚动条总长
		$(window).scroll(function() {
			var dh = $(document).height(); //整个页面文档的高度
			var to_top = $(this).scrollTop(); //滚动条的高度
			var wh = $(this).height(); //窗口的高度；
			_hght = dh - to_top - wh; //滚动到底部的位置；
			//返回到顶部按钮
			if (to_top > wh) {
				$("#to-top").show();
			} else {
				$("#to-top").hide();
			};
		});

		var list_load = setInterval(function() {
			var dh = $(document).height(); //整个页面文档的高度
			var to_top = $(this).scrollTop(); //滚动条的高度
			var wh = $(this).height(); //窗口的高度；
			_hght = dh - to_top - wh; //滚动到底部的位置；
			if (_hght < ($(document).height() / 3)) {
				var hasmore = $('input[name=hasmore]').val();
				if (hasmore == "false") {
					clearInterval(list_load);
				} else if (hasmore == "true") {
					loadmoredata();
				};
			};
		}, 1000);
	};

	//滚动加载取值
	function loadmoredata() {
		var curpage = eval(parseInt($("input[name=curpage]").val()) + 1);
		var ctype = $('.swiper-slide.active').attr('ctype');
		var atype = $('.swiper-slide.active').attr('atype');
		var typeid = $('.swiper-slide.active').attr('typeid');
		var api = ApiUrl + "/forum/index/index?ctype=" + ctype + "&atype=" + atype + "&typeid=" + typeid + "&curpage=" + curpage + "&page_size=" + pagesize;
		//console.log(api);
		$("input[name=ctype]").val(ctype);
		$("input[name=atype]").val(atype);
		$("input[name=typeid]").val(typeid);

		if (loadpage !== curpage) {
			loadpage = curpage;
			$.ajax({
				url: api,
				type: 'get',
				data: {
					key: key
				},
				dataType: 'json',
			}).done(function(result) {
				var datas = result.datas;
				$("input[name=curpage]").val(curpage);
				$("input[name=hasmore]").val(result.hasmore);
				$("input[name=page_total]").val(result.page_total);
				//数据加载判断
				if (atype == 1) {
					var navhtmls = template.render("strategy_list", datas);
				} else if (atype == 2) {
					var navhtmls = template.render("art_list", datas);
				} else if (atype == 3) {
					var navhtmls = template.render("activity_list", datas);
				};
				$("#forummain").append(navhtmls);

				$("#list_loading").hide();
				//相册
				$('.swipebox').swipebox();
				wh();

			}).fail(function(e) {}).always(function(e) {});
		}
	};

	function content_del() {
		$('.content_del').click(function() {
			var id = $(this).attr('id');
			$(window).appconfirm({
				msg: "是否删除这个帖子？",
				yes: function() {
					$.ajax({
						type: "post",
						url: ApiUrl + "/forum/index/forum_del",
						dataType: 'json',
						data: {
							id: id,
							key: key
						},
						timeout: '10000',
						error: function(a, b, c) {
							if (c != "error") {
								$(window).apptip({
									msg: c
								});
							} else {
								$(window).apptip({
									msg: "加载失败，请检查网络设置"
								});
							}
						},
						success: function(result) {
							var data = result.datas;
							if (result.code == 1) {
								$(window).apptip({
									msg: "删除中..."
								});
								init();
							} else {
								$(window).apptip({
									msg: "请检查网络设置"
								})
							}
						}
					});
				}
			})
			return false;
		})
	};
	
	//点赞
	function zambia() {
		$('.appreciate').click(function() {

			var id = $(this).attr('myid');
			if (key == '') {
				$(window).appconfirm({
					msg: '您尚未登录，请登录后进行评论！',
					yes: function() {
						location.href = location.href = '/login.html';
					}
				});
			} else {
				$.ajax({
					type: "post",
					url: ApiUrl + "/index/index/set_praise",
					dataType: 'json',
					data: {
						id: id,
						key: key
					},
					timeout: '10000',
					error: function(a, b, c) {
						if (c != "error") {
							$(window).apptip({
								msg: c
							});
						} else {
							$(window).apptip({
								msg: "加载失败，请检查网络设置"
							});
						}
					},
					success: function(result) {
						var data = result.datas;
						if (data == 1) {
							$('.appreciate').removeClass('ticon-appreciate').addClass('ticon-appreciatefill');

							$(window).apptip({
								msg: "已点赞！"
							});
						} else if (data == 2) {
							$('.appreciate').removeClass('ticon-appreciatefill').addClass('ticon-appreciate');
							$(window).apptip({
								msg: "已取消"
							})
						} else {
							$(window).apptip({
								msg: "请检查网络..."
							})
						}
					}
				});
			}
			return false;
		})
	};

	//接口设置初始化
	function setListUrl() {
		$("input[name=hasmore]").val('');
		$("input[name=page_total]").val('');
		$("input[name=curpage]").val(1);
	};

	function wh() {
		//图片等高
		$('.w_h.x4').each(function() {
			$(this).height($(this).width());
		});

		$('.tppre').each(function(i,e){
			var html=$(this).html();
			var showart='<span class="text-main margin-left tpshow">显示全部</span>';
			var len=html.length;
			if(len>80){
				var html_begin=html.substr(0,80);
				html_begin+=showart;
				var html_last=html.substr(81,len);
				$(e).html(html_begin);
				$(e).find('.tpshow').click(function(){
					$(e).html(html);
					return false;
				})
			}
		})
	}

});