$(function($) {
	var referurl = document.referrer; //上级网址
	if (referurl == null || referurl == "" || referurl.indexOf('login') > -1 || referurl.indexOf('register') > -1) {
		referurl = WapSiteUrl + "/user/index.html";
	}
	//表单验证
	$.validator.addMethod("ismobile", function(value, element) {
		var length = value.length;
		var mobiles = /^(1[3|4|5|7|8])+\d{9}?$/;
		return this.optional(element) || (length == 11 && mobiles.test(value));
	}, "请正确填写您的手机号码");
	jQuery.validator.addMethod("checkPic", function(value, element) {
		var filepath = $("#logo").val();
		//获得上传文件名
		var fileArr = filepath.split("\\");
		var fileTArr = fileArr[fileArr.length - 1].toLowerCase().split(".");
		var filetype = fileTArr[fileTArr.length - 1];
		//切割出后缀文件名
		if (filetype != "jpg") {
			return false;
		} else {
			return true;
		}
	}, "上传图片格式不适合");

	var checkForm = $("#login-form").validate({
		rules: {
			mobile: {
				required: true,
				ismobile: true
			},
			password: {
				required: true,
				minlength: 6,
				maxlength: 20
			}
		},
		messages: {
			mobile: {
				required: "请输入您的手机号码",
				ismobile: "手机格式有误"
			},
			password: {
				required: "请输入密码",
				minlength: "密码最少不少于6位"
			}
		},
		submitHandler: function() {
			login();
		}
	});

	function logout() {
		var key = getcookie('key');
		if (key == '') {
			location.href = WapSiteUrl;
		} else {
			//登出
			$('#logoutbtn').click(function() {
				$.ajax({
					type: 'get',
					url: ApiUrl + '/member/login/logout',
					data: {
						key: key,
						client: client
					},
					timeout: '10000',
					error: function(a, b, c) {
						console.log(b);
						if (c != "error") {
							$(window).apptip({
								msg: c
							});
						} else {
							$(window).apptip({
								msg: "加载失败，请检查网络设置"
							});
						}
					},
					success: function(result) {
						if (result) {
							delCookie('username');
							delCookie('key');
							delCookie('key');
							delCookie('lat');
							delCookie('lng');
							delCookie('city_name');
							delCookie('address');
							delCookie('iscart');
							$(window).apptip({
								msg: "cookies清除成功，请重新登录"
							});
						}
					}
				});
			});
		}

	}

	function login() {
		$(window).apploading({
			msg: "登录中..."
		});
		var mobile = $("#mobile").val();
		var password = $("#password").val();
		$.ajax({
			type: "post",
			url: ApiUrl + "/member/login",
			dataType: 'json',
			data: {
				mobile: mobile,
				password: password
			},
			timeout: '10000',
			error: function(a, b, c) {
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				$(window).appcloseload();
				if (result.code == 1) {
					if (typeof(result.datas.key) == 'undefined') {
						return false;
					} else {
						addcookie('key', result.datas.key);
						$(window).apptip({
							msg: "登录成功..."
						});
						setTimeout(function() {
							location.href = referurl;
						}, 500);
					}
					$(".error-tips").hide();
				} else {
					$(".error-tips").html(result.error).show();
					$(window).apptip({
						msg: result.error
					});
				}
			}
		});
	}
});