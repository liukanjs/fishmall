//发布帖子接口
//http://www.fish.com/api/forum/index/topic_add
//POST['key'] = '1234'
//POST['message'] = '1234'
//POST['img_list'] = '123.jpg,324.jpg,1231.jpg,1231.jpg,1231.jpg,1231.jpg,1231.jpg,1231.jpg,1231.jpg,1231.jpg,1231.jpg,1231.jpg,1231.jpg'
//POST['location'] = '1234'
var checkForm;
$(function() {
	var key = getcookie('key');
	if (key == '') {
		location.href = '/login.html';
	}

	//初始化图片url
	var imglist_val = [];

	$.ajax({
		url: ApiUrl + "/forum/index/nav_type",
		type: 'post',
		data: {
			ctype: 1,
			atype: 1
		},
		timeout: '16000',
		error: function(a, b, c) {
			NProgress.done();
			if (c != "error") {
				$(window).apptip({
					msg: c
				});
			} else {
				$(window).apptip({
					msg: "加载失败，请检查网络设置"
				});
			}
		},
		success: function(result) {
			var data = result.datas.class_type;
			if (result.code == 1) {
				$.each(data, function(i, e) {
					var html = '<option value="' + e.id + '">' + e.name + '</option>';
					$('#typeid').append(html);
				});
			} else {
				$(window).apptip({
					msg: result.error
				})
			}

		}
	});

	//话题图片等高
	$('.w_h').each(function() {
		$(this).height($(this).width());
	});

	//字数监控
	$('#message').keyup(function() {
		var len = $(this).val().length;
		$('#word_len').text(3000 - len);
	})

	//表单验证
	$.validator.addMethod("ismobile", function(value, element) {
		var length = value.length;
		var mobiles = /^(1[3|4|5|7|8])+\d{9}?$/;
		return this.optional(element) || (length == 11 && mobiles.test(value));
	}, "请正确填写您的手机号码");
	$.validator.addMethod("chinese", function(value, element) {
		var length = value.length;
		var chinese = /^[\u0391-\uFFE5]+$/;
		return this.optional(element) || (length <= 4 && chinese.test(value));
	}, "请正确填写中文姓名");
	jQuery.validator.addMethod("checkPic", function(value, element) {
		var filepath = $(element).val();
		//获得上传文件名
		var fileArr = filepath.split(",");
		var fileTArr = fileArr[fileArr.length - 1].toLowerCase().split(".");
		var filetype = fileTArr[fileTArr.length - 1];
		console.log(filetype);
		//切割出后缀文件名
		if (filetype === "jpg" || filetype === "gif" || filetype === "jpeg"|| filetype === "png") {
			return true;
		} else {
			return false;
		}
	}, "上传图片格式不适合");

	checkForm = $("#topic_add").validate({
		ignore: [],
		rules: {
			message: {
				required: true,
				minlength: 6,
				maxlength: 3000
			},
			typeid: {
				required: true
			},
			img_list: {
				checkPic: true
			},
			address: {
				required: true,
				minlength: 5,
				maxlength: 50
			}

		},
		messages: {
			message: {
				required: "请输入帖子内容",
				minlength: "帖子内容不得少于6个字",
				maxlength: "字太多啦。。。"
			},
			typeid: {
				required: "请选择社区频道"
			},
			img_list: {
				checkPic: "请使用正确的图片格式"
			},
			address: {
				required: "请填写您的地址",
				minlength: "字太少啦。。。",
				maxlength: "字太多啦。。。"
			}
		},
		submitHandler: function() {
			tpbtn();
		}
	});

	//发起帖子
	function tpbtn() {
		var ctype = 1;
		var atype = 1;
		var typeid = $("select[name=typeid]").val();
		var message = $("textarea[name=message]").val();
		var img_list = $("input[name=img_list]").val();
		var address = $("input[name=address]").val();

		$.ajax({
			type: "post",
			url: ApiUrl + "/forum/index/topic_add",
			dataType: 'json',
			data: {
				key: key,
				ctype: ctype,
				atype: atype,
				typeid: typeid,
				message: message,
				img_list: img_list,
				address: address
			},
			timeout: '10000',
			error: function(a, b, c) {
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				var data = result.datas;
				if (result.code == 1) {
					$(window).appalert({
						tit: "操作提示",
						msg: "操作成功，帖子已发布！",
						cbk: function() {
							window.location.href = WapSiteUrl + '/forum/index.html';
						}
					});
					return false;
				} else {
					$(window).apptip({
						msg: result.error
					})

				}

			}
		});

	};

	//上传图片
	$('#ppp').click(function() {
		var pic_len = 9;
		// 上传方法
		$.upload({
			// 上传地址
			url: '/api/index/upload',
			// 文件域名字
			fileName: 'filedata',
			// 其他表单数据
			params: {
				up: 1,
				key: key
			},
			// 上传完成后, 返回json, text
			dataType: 'json',
			// 上传之后回调
			onComplate: function(data) {
				var img_h = '<a class="x4 w_h padding-little text-center relative addimg"><img class="updata_pic" style="height:100%;width:100%" /><span class="ticon-close img_del"></span></a>'
				$('.field.line').prepend(img_h);
				$('.updata_pic').eq(0).attr('src', data.datas).show();

				//话题图片等高
				$('.w_h').each(function() {
					$(this).height($(this).width());
				});

				imglist_val.unshift(data.datas);
				console.log(data.datas);
				$("input[name=img_list]").val(imglist_val.toString());

				//删除图片事件
				del_img();

			},
			// 上传之前回调,return true表示可继续上传
			onSend: function() {
				if ($('.updata_pic').size() >= pic_len) {
					$(window).appalert({
						msg: "每个帖子最多只能上传9张图片"
					});
					return false;
				} else {
					return true;
				}
			}
		});
	})

	function del_img() {
		Array.prototype.del = function(n) {　
			if (n < 0)　 {　　
				return this;　
			} else {
				return this.slice(0, n).concat(this.slice(n + 1, this.length));　
			}　　
		};

		$('.img_del').each(function(i, e) {
			$(this).click(function() {
				var index = $('.img_del').index($(this)); //当前按钮的索引值
				var html = $(this).parent('.addimg');
				html.remove();
				var val = $("input[name=img_list]").val().split(',');
				console.log(val);
				val = val.del(index);
				imglist_val = imglist_val.del(index);
				$("input[name=img_list]").val(val.toString());
			})
		});

	}

})