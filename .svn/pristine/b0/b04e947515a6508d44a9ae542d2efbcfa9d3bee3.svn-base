//收藏商品
//http://www.fish.com/api.php/member/index/fav_goods
//POST['key'] = '1234'

$(function() {
	var key = getcookie('key');
	if (key == '') {
		location.href = '/login.html';
	}
	var isok = false;
	init();

	function init() {

		$.ajax({
			url: ApiUrl + "/member/index/fav_goods",
			type: 'POST',
			data: {
				key: key
			},
			timeout: '16000',
			error: function(a, b, c) {
				NProgress.done();
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				NProgress.done();
				var data = result.datas;
				var html = '';
				if (data == null) {
					location.href = '/404.html';
					return;
				}
				isok = true;
				html = template.render('fav_goods', data);
				$("#main-container").html(html);

				//图片预加载
				$('img.pre').each(function(i, e) {
					var _src = $(this).attr("data-img");
					$(this).attr("src", _src);
				});
				
				goods_del();

			}
		});
	}

	function goods_del() {
		$('.ticon-deletefill').click(function() {
			var goods_id = $(this).attr('goods_id');
			$.ajax({
				url: ApiUrl + "/index/index/set_like",
				type: 'POST',
				data: {
					key: key,
					id: goods_id
				},
				timeout: '16000',
				error: function(a, b, c) {
					NProgress.done();
					if (c != "error") {
						$(window).apptip({
							msg: c
						});
					} else {
						$(window).apptip({
							msg: "加载失败，请检查网络设置"
						});
					}
				},
				success: function(result) {
						var data = result.datas;
						if (result.code == 1) {
								$(window).apptip({
									msg: "取消收藏！"
								});
							init();
						} else {
							$(window).apptip({
								msg: "请检查网络设置"
							})
						}

				}
			});
		})
	}

	//自动显示回到顶部按钮
	var scrolll_hght;
	var totophtml = '';
	$(window).scroll(function() {
		var dh = $(document).height(); //整个页面文档的高度
		var to_top = $(this).scrollTop(); //滚动条的高度
		var wh = $(this).height(); //窗口的高度；
		scrolll_hght = dh - to_top - wh; //滚动到底部的位置；
		//返回到顶部按钮
		if (to_top > wh) {
			$("#to-top").show();
		} else {
			$("#to-top").hide();
		};
	});

});