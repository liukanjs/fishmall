//渔具列表
//http://www.fish.com/api.php/mall/index/goods_list
//GET[keyword] = [搜索关键字]——二选一
//GET[typeid] = [商品分类的id]
//GET[goods_type] = [0:全部，1:非鱼古抵扣商品，2:鱼古抵扣商品]
//GET[type] = [1,2,3,4综合、销量、价格、人气]
//GET[order] = [排序asc,desc]
//GET[curpage] = [页数]
//GET[pagesize] = [分页数]

$(function() {
	var key = getcookie('key');
	var loadpage = 0;
	//  if (key == '') {
	//      location.href = '/login.html';
	//  }
	var goods_type = GetQueryString("goods_type");
	var typeid = GetQueryString("typeid");
	var keyword = escape(GetQueryString('keyword'));

	$("input[name=keyword]").val(escape(GetQueryString('keyword')));
	$("input[name=typeid]").val(GetQueryString('typeid'));
	$("input[name=goods_type]").val(GetQueryString('goods_type'));

	var isok = false;
	init();

	function init() {
		var api = '';
		if (keyword == 'null' || keyword == "" || keyword == null) {
			api = ApiUrl + "/mall/index/goods_list?typeid=" + typeid + "&goods_type=" + goods_type + "&curpage=1&page_size=" + pagesize;
		} else {
			api = ApiUrl + "/mall/index/goods_list?keyword=" + keyword + "&curpage=1&page_size=" + pagesize;
		}

		$.ajax({
			url: api,
			type: 'get',
			timeout: '16000',
			error: function(a, b, c) {
				NProgress.done();
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				NProgress.done();
				var data = result.datas;
				var html = '';
				if (data == null) {
					location.href = '/404.html';
					return;
				}
				$("input[name=hasmore]").val(result.hasmore);
				$("input[name=page_total]").val(result.page_total);

				isok = true;
				html = template.render('goods_list', data);
				$("#main-container").html(html);
				
				order_list();
				scrollLoad();

			}
		});
	}

	function order_list() {
		$('.keyorder').each(function() {
			$(this).click(function() {
				if ($(this).attr('key') == 1) {
					$('keyorder').removeClass('current');
					$(this).addClass('current');
					init();
					return;
				}

				if ($(this).attr('order') == "asc" && $(this).attr('class') == 'keyorder current') {
					$(this).attr('order', 'desc');
					$(this).find('span').removeClass('ticon-fold').addClass('ticon-fold');
					$("input[name=order]").val('desc');
				} else {
					$(this).attr('order', 'asc');
					$(this).find('span').removeClass('ticon-unfold').addClass('ticon-unfold');
					$("input[name=order]").val('asc');
				};

				$('.keyorder').removeClass('current');
				$(this).addClass('current');

				var order = $("input[name=order]").val();
				var type = $(this).attr('key');
				var typeid = $("input[name=typeid]").val();
				var goods_type = $("input[name=goods_type]").val();
				
				
				var api = '';
				if (keyword == 'null' || keyword == "" || keyword == null) {
					api = ApiUrl + "/mall/index/goods_list?type=" + type + "&order=" + order + "&typeid=" + typeid + "&goods_type=" + goods_type + "&curpage=1&page_size=" + pagesize;
				} else {
					api = ApiUrl + "/mall/index/goods_list?keyword=" + keyword + "&curpage=1&page_size=" + pagesize;
				}
				
				$('#main-container').html('');
				
				$("input[name=type]").val(type);
				$("input[name=goods_type]").val(goods_type);
				$("input[name=curpage]").val(1);

				$.ajax({
					url: api,
					type: 'get',
					timeout: '16000',
					error: function(a, b, c) {
						NProgress.done();
						if (c != "error") {
							$(window).apptip({
								msg: c
							});
						} else {
							$(window).apptip({
								msg: "加载失败，请检查网络设置"
							});
						}
					},
					success: function(result) {
						var data = result.datas;
						var htmls = '';
						if (data == null) {
							$(window).appalert({
								msg: "数据读取错误，请检查网络！"
							})
							return;
						}
						$("input[name=hasmore]").val(result.hasmore);
						$("input[name=page_total]").val(result.page_total);
						isok = true;

						//初始化页面
						var html = template.render("goods_list", data);
						$("#main-container").html(html);

						$("#list_loading").hide();
						setTimeout(function() {
							scrollLoad();
						}, 1500)
					}
				});

			});
		});
	};

	//滚动加载
	function scrollLoad() {
		var _hght; //初始化滚动条总长
		$(window).scroll(function() {
			var dh = $(document).height(); //整个页面文档的高度
			var to_top = $(this).scrollTop(); //滚动条的高度
			var wh = $(this).height(); //窗口的高度；
			_hght = dh - to_top - wh; //滚动到底部的位置；
			//返回到顶部按钮
			if (to_top > wh) {
				$("#to-top").show();
			} else {
				$("#to-top").hide();
			};
		});

		var list_load = setInterval(function() {
			var dh = $(document).height(); //整个页面文档的高度
			var to_top = $(this).scrollTop(); //滚动条的高度
			var wh = $(this).height(); //窗口的高度；
			_hght = dh - to_top - wh; //滚动到底部的位置；
			if (_hght < ($(document).height() / 3)) {
				var hasmore = $('input[name=hasmore]').val();
				if (hasmore == "false") {
					clearInterval(list_load);
				} else if (hasmore == "true") {
					loadmoredata();
				};
			};
		}, 3000);
	};

	//滚动加载取值
	function loadmoredata() {
		var curpage = eval(parseInt($("input[name=curpage]").val()) + 1);
		var order = $("input[name=order]").val();
		var type = $("input[name=type]").val();
		var typeid = $("input[name=typeid]").val();
		var goods_type = $("input[name=goods_type]").val();
		var api=api = ApiUrl + "/mall/index/goods_list?type=" + type + "&order=" + order + "&typeid=" + typeid + "&goods_type=" + goods_type + "&curpage="+curpage+"&page_size=" + pagesize;
		console.log(api);
		
		
		$("input[name=type]").val(type);
		$("input[name=typeid]").val(typeid);
		$("input[name=goods_type]").val(goods_type);
		$("input[name=order]").val(order);

		if (loadpage !== curpage) {
			loadpage = curpage;
			$.ajax({
				url: api,
				type: 'get',
				dataType: 'json',
			}).done(function(result) {
				var datas = result.datas;
				$("input[name=curpage]").val(curpage);
				$("input[name=hasmore]").val(result.hasmore);
				$("input[name=page_total]").val(result.page_total);

				var html = template.render("goods_list", datas);
				$("#main-container").append(html);

				$("#list_loading").hide();

			}).fail(function(e) {}).always(function(e) {});
		}
	};

	//接口设置初始化
	function setListUrl() {
		$("input[name=hasmore]").val('');
		$("input[name=page_total]").val('');
		$("input[name=curpage]").val(1);
	};

});