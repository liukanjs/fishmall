//话题详情页
//http://www.fish.com/api.php/forum/index/topic_info?topic_id=100

$(function() {
	var key = getcookie('key');
	var topic_id = GetQueryString("topic_id");
	//渲染页面
	$.ajax({
		url: ApiUrl + "/forum/index/topic_info",
		type: 'post',
		dataType: 'json',
		data: {
			topic_id: topic_id,
			key: key
		},
		timeout: '10000',
		error: function(a, b, c) {
			if (c != "error") {
				$(window).apptip({
					msg: c
				});
			} else {
				$(window).apptip({
					msg: "加载失败，请检查网络设置"
				});
			}
		},
		success: function(result) {
			var data = result.datas;
			var html = '';
			if (data == null) {
				location.href = '/404.html';
				return;
			}
			isok = true;
			$.each(data, function(k, v) {
				html += template.render(k, v);
			});
			$("#main-container").html(html);
			//话题图片等高
			$('.w_h').each(function() {
				$(this).height($(this).width());
			});
			//相册
			$('.swipebox').swipebox();
			//点赞
			zambia();

			content_del();

			//评论事件
			$('#comment').click(function() {
				if (key == '') {
					$(window).appconfirm({
						msg: '您尚未登录，请登录后进行评论！',
						yes: function() {
							location.href = location.href = '/login.html';
						}
					});
				} else {
					var messages = $('#message').val();
					if (messages != '') {
						$.ajax({
							type: "post",
							url: ApiUrl + "/index/index/get_discuss_list",
							dataType: 'json',
							data: {
								id: topic_id,
								key: key,
								messages: messages
							},
							timeout: '10000',
							error: function(a, b, c) {
								if (c != "error") {
									$(window).apptip({
										msg: c
									});
								} else {
									$(window).apptip({
										msg: "加载失败，请检查网络设置"
									});
								}
							},
							success: function(result) {
								var data = result.datas;
								var comment_html = "";
								if (result.code == 1) {
									comment_html = template.render('discuss_list', data.discuss_list);
									$('#comment_list').remove();
									$('#comment_add').before(comment_html);
									$(window).appalert({
										tit: "操作提示",
										msg: "评论成功！"
									});
									$('#message').val('');

									var offset_top = $('#comment_list').offset().top;
									$('body,html').animate({
										scrollTop: offset_top - $('header').height()
									}, 300);
									return false;
								} else {
									$(window).apptip({
										msg: "请检查网络设置"
									})

								}

							}
						});
					} else {
						$(window).apptip({
							msg: "请输入评论内容"
						})
					}

				}
			})

			$('.emotion').qqFace({
				id: 'facebox',
				assign: 'message',
				path: '/static/arclist/' //表情存放的路径
			});
		}

	});

	function set_like() {
		$('#like').click(function() {
			if (key == '') {
				$(window).appconfirm({
					msg: '您尚未登录，请登录后进行评论！',
					yes: function() {
						location.href = location.href = '/login.html';
					}
				});
			} else {
				var likenum = $(this).attr('like');
				if (likenum == 0 || likenum == 2) {
					$.ajax({
						type: "post",
						url: ApiUrl + "/index/index/get_top_list",
						dataType: 'json',
						data: {
							id: topic_id,
							key: key
						},
						timeout: '10000',
						error: function(a, b, c) {
							if (c != "error") {
								$(window).apptip({
									msg: c
								});
							} else {
								$(window).apptip({
									msg: "加载失败，请检查网络设置"
								});
							}
						},
						success: function(result) {
							var data = result.datas;
							if (result.code == 1) {
								$('#like').attr({
									'like': 1
								});
								$('#like').removeClass('ticon-like');
								$('#like').addClass('ticon-likefill');
								$(window).apptip({
									msg: "收藏成功！"
								});
							} else {
								$(window).apptip({
									msg: "请检查网络设置"
								})
							}
						}
					});
				} else {
					$(window).apptip({
						msg: "您已经收藏过啦..."
					})
				}

			}
		})
	}

	function content_del() {
		$('.content_del').click(function() {
			$(window).appconfirm({
				msg: "是否删除这个帖子？",
				yes: function() {
					$.ajax({
						type: "post",
						url: ApiUrl + "/forum/index/forum_del",
						dataType: 'json',
						data: {
							id: topic_id,
							key: key
						},
						timeout: '10000',
						error: function(a, b, c) {
							if (c != "error") {
								$(window).apptip({
									msg: c
								});
							} else {
								$(window).apptip({
									msg: "加载失败，请检查网络设置"
								});
							}
						},
						success: function(result) {
							var data = result.datas;
							if (result.code == 1) {
								$(window).apptip({
									msg: "已删除,跳转中..."
								});
								setTimeout(function() {
									window.location.href = WapSiteUrl + '/forum/index.html';
								}, 500)
							} else {
								$(window).apptip({
									msg: "请检查网络设置"
								})
							}
						}
					});
				}
			})
		})
	}

	//点赞
	function zambia() {
		$('.appreciate').click(function() {
			if (key == '') {
				$(window).appconfirm({
					msg: '您尚未登录，请登录后进行评论！',
					yes: function() {
						location.href = location.href = '/login.html';
					}
				});
			} else {
				$.ajax({
					type: "post",
					url: ApiUrl + "/index/index/set_praise",
					dataType: 'json',
					data: {
						id: topic_id,
						key: key
					},
					timeout: '10000',
					error: function(a, b, c) {
						if (c != "error") {
							$(window).apptip({
								msg: c
							});
						} else {
							$(window).apptip({
								msg: "加载失败，请检查网络设置"
							});
						}
					},
					success: function(result) {
						var data = result.datas;
						if (data == 1) {
							$('.appreciate').removeClass('ticon-appreciate').addClass('ticon-appreciatefill');

							$(window).apptip({
								msg: "已点赞！"
							});
						} else if (data == 2) {
							$('.appreciate').removeClass('ticon-appreciatefill').addClass('ticon-appreciate');
							$(window).apptip({
								msg: "已取消"
							})
						} else {
							$(window).apptip({
								msg: "请检查网络..."
							})
						}
					}
				});
			}
		})
	};

});