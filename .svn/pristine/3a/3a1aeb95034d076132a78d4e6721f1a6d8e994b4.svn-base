$(function() {
	var key = getcookie('key');
	if (key == '') {
		location.href = 'login.html';
	}

	var iscart=getcookie('iscart'); //0：无需跳转cart，1需跳转cart
	//初始化列表
	function initPage() {
		$.ajax({
			type: 'post',
			url: ApiUrl + "/member/index/address_list",
			data: {
				key: key
			},
			dataType: 'json',
			timeout: '10000',
			error: function(a, b, c) {
				console.log(b);
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				var data = result.datas;
				var html = template.render('address_list', data);

				$("#add_list").html(html);
				//点击删除地址
				$('.deladdress').click(delAddress);
				//设置默认地址
				$('.defaddress').click(defAddress);
			}
		});
	}
	initPage();

	//默认地址设置
	function defAddress() {
		var address_id = $(this).attr('address_id');
		$.ajax({
			type: 'post',
			url: ApiUrl + "/member/index/address_default",
			data: {
				id: address_id,
				key: key
			},
			dataType: 'json',
			timeout: '10000',
			error: function(a, b, c) {
				console.log(b);
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				var data = result.datas;

				if (iscart == 1) {
					location.href = "/mall/cart.html";
				} else {

					if (data == 1) {
						$(window).apptip({
							msg: "默认地址设置成功"
						});
						initPage();
					}
				}

			}
		});
	};

	//点击删除地址
	function delAddress() {
		var address_id = $(this).attr('address_id');
		
		$.ajax({
			type: 'post',
			url: ApiUrl + "/member/index/address_del",
			data: {
				id: address_id,
				key: key
			},
			dataType: 'json',
			timeout: '10000',
			error: function(a, b, c) {
				console.log(b);
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				var data = result.datas;
				if (data == 1) {
					$(window).apptip({
						msg: "地址删除成功"
					});
					initPage();
				}
			}
		});
	}
});