<?php
namespace common\model;

use think\Model;
use common\model\ScoreLog as SL;
use common\model\ExperienceLog as EL;
use think\controller\User;

class UserInfo extends Model
{
    protected $type = [
        'create_time' => 'timestamp:Y/m/d H:i:s',
        'update_time' => 'timestamp:Y/m/d H:i:s'
    ];

    public function User_List($curpage, $page_size, $search)
    {
        $result = array();
        $model = $this->db();
        if (!empty($search['keyword'])) {
            $model->where('user_name', 'like', '%' . $search['keyword'] . '%');
        }
        $options = $model->getOptions();
        $num_rows = $model->count();
        trace($model->options($options)->buildSql(), 'sql');
        $data_rows = $model->options($options)->order('id desc')->page($curpage, $page_size)->select();
        $result['data'] = $data_rows;
        $result['page'] = ceil($num_rows / $page_size);
        return $result;
    }

    /**
     * TODO 经验值操作
     *
     * @param int $user_id
     * @param int $experience
     * @param string $note
     */
    public function User_Experience($user_id = 0, $experience = 0, $note = '')
    {
        if ($user_id == 0) return;
        $model_el = new EL;
        $this->where(['id' => $user_id])->setInc('experience', $experience);
        $model_el->save(['user_id' => $user_id, 'experience' => $experience, 'note' => $note]);
    }


    /**
     * TODO 同步鱼鳞值
     *
     * @param int $user_id
     * @param int $score
     * @param string $note
     */
    public function User_Score($user_id = 0, $score = 1, $note = '')
    {
        if ($user_id == 0) return;
        $model_sl = new SL;
        $this->where(['id' => $user_id])->setInc('score', $score);
        $model_sl->save(['user_id' => $user_id, 'score' => $score, 'note' => $note]);
		 if($score>0){
            $game_id=$this->where(['id' => $user_id])->value('gameid');
            $user=new User();
            $user->integral_query('', $game_id, TIMESTAMP, $score);
        }
    }
}