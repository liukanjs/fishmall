var packer = null;
$.getScript("/static/js/base2.js", function () {
    packer = new Packer;
});
$.validator.setDefaults({
    highlight: function (e) {
        $(e).closest(".form-group").removeClass("has-success").addClass("has-error")
    },
    success: function (e) {
        e.closest(".form-group").removeClass("has-error").addClass("has-success")
    },
    errorElement: "span",
    errorPlacement: function (e, r) {
        e.appendTo(r.is(":radio") || r.is(":checkbox") ? r.parent().parent().parent() : r.parent())
    },
    errorClass: "help-block m-b-none",
    validClass: "help-block m-b-none"
}), $.validator.addMethod("chinese", function (value, element) {
    var chinese = /^[\u0391-\uFFE5]+$/;
    return this.optional(element) || (chinese.test(value));
}, "请正确填写中文"), $.validator.addMethod("mobile", function (value, element) {
    var length = value.length;
    var mobile = /^(1[3|4|5|7|8])+\d{9}?$/;
    return this.optional(element) || (length == 11 && mobile.test(value));
}, "请正确填写您的手机号码"), $.validator.addMethod("tel", function (value, element) {
    var tel = /^((\(\d{2,3}\))|(\d{3}\-))?(\(0\d{2,3}\)|0\d{2,3}-)?[1-9]\d{6,7}(\-\d{1,4})?$/;
    return this.optional(element) || (tel.test(value));
}, "请正确填写您的电话号码"), $.validator.addMethod("isIdCardNo", function (value, element) {
    return this.optional(element) || isIdCardNo(value);
}, "请正确输入您的身份证号码");

$(function ($) {
    $("#commentForm").validate({
        submitHandler: function (_form) {
            var form = $(_form),
                _ac = form.attr('action'),
                ac = typeof _ac == "undefined" ? '' : _ac;
            form.find('.summernote').each(function (key, item) {
                $('<input name="' + $(item).attr('id') + '" type="hidden" />').val(packer.pack(($(item).code()), 0, 0)).appendTo(form);
            });
            $.ajax({
                type: "POST",
                url: ac + (ac.indexOf("?") == -1 ? "?" : "&") + "form_submit=ok",
                data: form.serializeArray(),
                success: function (json) {
                    if (json.code == 0) {
                        toastr.error(json.error, "错误提示")
                    } else {
                        parent.layer.alert('操作成功！', {
                            skin: 'layui-layer-molv' //样式类名
                        }, function () {
                            parent.layer.closeAll();
                            window.history.back(-1);
                        });
                    }
                }
            });
            return false;
        }
    });
    var e = "<i class='fa fa-times-circle'></i> ";

    $('select[value]').each(function (index, value) {
        $(this).val($(this).attr('value'))
    });
});
/**
 * 将josn对象赋值给form
 * @param {dom} 指定的选择器
 * @param {obj} 需要给form赋值的json对象
 * @method serializeJson
 * */
$.fn.setForm = function (jsonValue) {
    var obj = this;
    $.each(jsonValue, function (name, ival) {
        var $oinput = obj.find("input[name=" + name + "]");
        if ($oinput.attr("type") == "checkbox") {
            if (ival !== null) {
                var checkboxObj = $("[name=" + name + "]");
                var checkArray = ival.split(";");
                for (var i = 0; i < checkboxObj.length; i++) {
                    for (var j = 0; j < checkArray.length; j++) {
                        if (checkboxObj[i].value == checkArray[j]) {
                            checkboxObj[i].click();
                        }
                    }
                }
            }
        } else if ($oinput.attr("type") == "radio") {
            $oinput.each(function () {
                var radioObj = $("[name=" + name + "]");
                for (var i = 0; i < radioObj.length; i++) {
                    if (radioObj[i].value == ival) {
                        radioObj[i].click();
                    }
                }
            });
        } else if ($oinput.attr("type") == "textarea") {
            obj.find("[name=" + name + "]").html(ival);
        } else {
            obj.find("[name=" + name + "]").val(ival);
        }
    })
}