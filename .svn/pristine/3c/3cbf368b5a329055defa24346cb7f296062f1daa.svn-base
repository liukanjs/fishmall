$(function ($) {
	var username=decodeURIComponent(getcookie('username'));
	$('#name').val(username);
	
    var referurl = document.referrer; //上级网址
    if (referurl == null || referurl == "" || referurl.indexOf('login') > -1 || referurl.indexOf('register') > -1) {
        referurl = WapSiteUrl + "/user/index.html";
    }
    //表单验证
    $.validator.addMethod("ismobile", function (value, element) {
        var length = value.length;
        var mobiles = /^(1[3|4|5|7|8])+\d{9}?$/;
        return this.optional(element) || (length == 11 && mobiles.test(value));
    }, "请正确填写您的手机号码");
    $.validator.addMethod("chinese", function (value, element) {
        var length = value.length;
        var chinese = /^[\u0391-\uFFE5]+$/;
        return this.optional(element) || (length <= 4 && chinese.test(value));
    }, "请正确填写中文姓名");

    var checkForm = $("#reg").validate({
        rules: {
            mobile: {
                required: true,
                ismobile: true,
                remote: {
                    url: ApiUrl + '/member/login/check_mobile',
                    type: 'post',
                    data: {
                        mobile: function () {
                            return $('#mobile').val();
                        }
                    }
                }
            },
            name: {
                required: true,
                minlength: 2,
                maxlength: 20,
            },
            //captcha: {
            //    required: true,
            //    minlength: 6,
            //    maxlength: 6,
            //    remote: {
            //        url: ApiUrl + '/member/login/check_captcha',
            //        type: 'post',
            //        data: {
            //            captcha: function () {
            //                return $('#captcha').val();
            //            },
            //            mobile: function () {
            //                return $('#mobile').val();
            //            }
            //        },
            //        complete: function (data) {
            //
            //        }
            //    }
            //
            //},
            password: {
                required: true,
                minlength: 6,
                maxlength: 20
            },
            confirm_password: {
                required: true,
                minlength: 6,
                maxlength: 20,
                equalTo: "#password"
            },
        },
        messages: {
            mobile: {
                required: "请输入您的手机号码",
                ismobile: "手机格式有误",
                remote: "该手机号已被注册！"
            },
            name: {
                required: "请输入您的昵称",
                minlength: "最少2个字",
                maxlength: "最多20个字",
            },
            //captcha: {
            //    required: "请输入验证码",
            //    minlength: "验证码最少6位数",
            //    maxlength: "验证码最多6位数",
            //    remote: "短信验证码有误！"
            //
            //},
            password: {
                required: "请输入密码",
                minlength: "密码最少6位数",
                maxlength: "密码最多20位数",
            },
            confirm_password: {
                required: "请再次输入密码",
                minlength: "密码最少6位数",
                maxlength: "密码最多20位数",
                equalTo: "两次输入的密码不一致"
            }
        },
        submitHandler: function () {
            register();
        }
    });

    $('.getcode').click(function () {	//获取手机验证码事件
        if ($(this).attr('disabled') == 'disabled') {
            $(window).apptip({
                msg: '验证码已发送，请勿重复获取.'
            });
            retrun;
        } else {
            var mobile_obj = $('#mobile');
            var getcode_obj = $('.getcode');
            var mobile = mobile_obj.val();
            if (mobile.length == 11 && /^(1[3|4|5|7|8])+\d{9}?$/.test(mobile)) {
                $.ajax({
                    type: 'post',
                    url: ApiUrl + '/member/login/send_captcha',
                    dataType: 'json',
                    data: {'mobile': mobile},
                    timeout: '10000',
                    error: function (a, b, c) {
                        $(window).apptip({
                            msg: "加载失败，请检查网络设置"
                        });
                    },
                    success: function (result) {
                        var data = result.datas;
                        mobile_obj.attr('disabled', 'disabled');
                        getcode_obj.attr('disabled', 'disabled');
                        getcode_obj.text('已发送');
                        $(window).apptip({
                            msg: "短信验证码一个小时内有效"
                        });
                        var t = 200;
                        var time = setInterval(function () {
                            t--;
                            getcode_obj.text(t + "秒");
                            if (t == 0) {
                                clearInterval(time);
                                getcode_obj.removeAttr('disabled').text('获取验证码');
                                mobile_obj.removeAttr('disabled');
                            }
                        }, 1000)
                    }
                });
            } else {
                $(window).apptip({
                    msg: '请填写正确的手机号码'
                });
            }
        }
    });

    function register() {
        var mobile = $("#mobile").val();
        var name = $("#name").val();
        var captcha = $("#captcha").val();
        var password = $("#password").val();
        var confirm_password = $("#confirm_password").val();
        $.ajax({
            type: "post",
            url: ApiUrl + "/member/login/register",
            dataType: 'json',
            data: {
                mobile: mobile,
                name: name,
                //captcha: captcha,
                password: password,
                confirm_password: confirm_password
            },
            timeout: '10000',
            error: function (a, b, c) {
                if (c != "error") {
                    $(window).apptip({
                        msg: c
                    });
                } else {
                    $(window).apptip({
                        msg: "加载失败，请检查网络设置"
                    });
                }
            },
            success: function (result) {
                if (result.code == 1) {
                    $(".error-tips").hide();
                    if (typeof(result.datas.key) == 'undefined') {
                        return false;
                    } else {
                        addcookie('key', result.datas.key);
                        $(window).apptip({
                            msg: "注册成功..."
                        });
                        setTimeout(function () {
                            location.href = referurl;
                        }, 500);
                    }
                } else {
                    $(".error-tips").html(result.error).show();
                    $(window).apptip({
                        msg: result.error
                    });
                }
            }
        });

    }
    
    function check_ajax_mobile() {
		$('#mobile').blur();
		var checkmobile = checkmobile = checkForm.element($('#mobile'));
		console.log(checkmobile);
		if (checkmobile) {
			var mobile_obj = $('#mobile');
			var getcode_obj = $('.getcode');
			var mobile = mobile_obj.val();
			if (mobile.length == 11 && /^(1[3|4|5|7|8])+\d{9}?$/.test(mobile)) {
				$.ajax({
					type: 'post',
					url: ApiUrl + '/member/login/check_mobile',
					dataType: 'json',
					data: {
						'mobile': mobile
					},
					timeout: '10000',
					error: function(a, b, c) {
						$(window).apptip({
							msg: "加载失败，请检查网络设置"
						});
					},
					success: function(result) {
						console.log('手机号可注册')
						return result;
					}
				});
			} else {
				return false;
			}

		} else {
			return false;
		}
	}
});