//活动详情页
//http://www.fish.com/api.php/forum/index/activity_info?activity_id=100

$(function () {
    var key = getcookie('key');
    var activity_id = GetQueryString("activity_id");
    //渲染页面
    $.ajax({
        url: ApiUrl + "/forum/index/activity_info",
        type: 'post',
        dataType: 'json',
        data: {
            activity_id: activity_id,
            key: key
        },
        timeout: '10000',
        error: function (a, b, c) {
            if (c != "error") {
                $(window).apptip({
                    msg: c
                });
            } else {
                $(window).apptip({
                    msg: "加载失败，请检查网络设置"
                });
            }
        },
        success: function (result) {
            var data = result.datas;
            var html = '';
            if (data == null) {
                location.href = '/404.html';
                return;
            }
            isok = true;
            $.each(data, function (k, v) {
                html += template.render(k, v);
            });
            var title = data.activity.title;
            $("#title,title").text(title);
            $("#main-container").html(html);

            //地图跳转
            $('#tomap').click(function () {
                $(window).apploading({
                    msg: "跳转地图中，请稍后..."
                });
            })

            //评论事件
            $('#comment').click(function () {
                if (key == '') {
                    $(window).appconfirm({
                        msg: '您尚未登录，请登录后进行评论！',
                        yes: function () {
                            location.href = location.href = '/login.html';
                        }
                    });
                } else {
                    var messages = $('#message').val();
                    if (messages != '') {
                        $.ajax({
                            type: "post",
                            url: ApiUrl + "/index/index/get_discuss_list",
                            dataType: 'json',
                            data: {
                                id: activity_id,
                                key: key,
                                messages: messages
                            },
                            timeout: '10000',
                            error: function (a, b, c) {
                                if (c != "error") {
                                    $(window).apptip({
                                        msg: c
                                    });
                                } else {
                                    $(window).apptip({
                                        msg: "加载失败，请检查网络设置"
                                    });
                                }
                            },
                            success: function (result) {
                                var data = result.datas;
                                var comment_html = "";
                                if (result.code == 1) {
                                    comment_html = template.render('discuss_list', data.discuss_list);
                                    $('#comment_list').remove();
                                    $('#comment_add').before(comment_html);
                                    $(window).appalert({
                                        tit: "操作提示",
                                        msg: "评论成功！"
                                    });
									$('#message').val('');
                                    var offset_top = $('#comment_list').offset().top;
                                    $('body,html').animate({
                                        scrollTop: offset_top - $('header').height()
                                    }, 300);
                                    return false;
                                } else {
                                    $(window).apptip({
                                        msg: "请检查网络设置"
                                    })
                                }
                            }
                        });
                    } else {
                        $(window).apptip({
                            msg: "请输入评论内容"
                        })
                    }

                }
            })


            $('.emotion').qqFace({
                id: 'facebox',
                assign: 'message',
                path: '/static/arclist/' //表情存放的路径
            });
        }

    });

    function AddView() { //增加浏览记录
        var activity_id = getcookie('activity_id');
        if (key != '') {
            if (activity_id == '') {
                $.ajax({
                    type: "post",
                    url: ApiUrl + "/index/index/get_discuss_list",
                    dataType: 'json',
                    data: {
                        id: activity_id,
                        key: key
                    },
                    timeout: '10000',
                    error: function (a, b, c) {
                        if (c != "error") {
                            $(window).apptip({
                                msg: c
                            });
                        } else {
                            $(window).apptip({
                                msg: "加载失败，请检查网络设置"
                            });
                        }
                    },
                    success: function (result) {
                        var data = result.datas;

                        addcookie('activity_id', activity_id);
                        return false;

                    }
                });
            }
        }

    }

});