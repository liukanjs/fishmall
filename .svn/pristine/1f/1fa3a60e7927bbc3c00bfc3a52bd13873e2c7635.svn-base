var checkForm;
$(function() {

	var key = getcookie('key');
	if (key == '') {
		location.href = '/login.html';
	}

	//初始化
	$.ajax({
		url: ApiUrl + "/member/index/index",
		type: 'POST',
		data: {
			key: key
		},
		timeout: '16000',
		error: function(a, b, c) {
			if (c != "error") {
				$(window).apptip({
					msg: c
				});
			} else {
				$(window).apptip({
					msg: "加载失败，请检查网络设置"
				});
			}
		},
		success: function(result) {
			NProgress.done();
			var data = result.datas.my_info;
			var html = '';
			if (data == null) {
				location.href = '/login.html';
				return;
			}
			$('#user_name').val(data.user_name);
			$('#imgshow').attr('src', data.user_icon);
			$('#user_icon').val(data.user_icon);

		}
	});

	//表单验证
	jQuery.validator.addMethod("checkPic", function(value, element) {
		var filepath = $(element).val();
		//获得上传文件名
		var fileArr = filepath.split(",");
		var fileTArr = fileArr[fileArr.length - 1].toLowerCase().split(".");
		var filetype = fileTArr[fileTArr.length - 1];
		console.log(filetype);
		//切割出后缀文件名
		if (filetype === "jpg" || filetype === "gif" || filetype === "jpeg" || filetype === "png") {
			return true;
		} else {
			return false;
		}
	}, "上传图片格式不适合");

	checkForm = $("#user_edit").validate({
		ignore: [],
		rules: {
			user_name: {
				required: true,
				minlength: 2
			},
			user_icon: {
				required: true,
				checkPic: true
			}
		},
		messages: {
			user_name: {
				required: "请输入活动标题",
				minlength: "昵称不得少于2个字"
			},
			user_icon: {
				required: "请上传图片",
				checkPic: "请使用jpg的图片格式"
			}
		},
		submitHandler: function() {
			user_edit();
		}
	});

	//修改个人资料
	function user_edit() {
		var user_name = $("input[name=user_name]").val();
		var user_icon = $("input[name=user_icon]").val();

		$.ajax({
			url: ApiUrl + "/member/index/user_edit",
			type: 'POST',
			data: {
				key: key,
				user_name: user_name,
				user_icon: user_icon,
			},
			timeout: '16000',
			error: function(a, b, c) {
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				var data = result.datas;
				if (result.code == 1) {
					$(window).appalert({
						tit: "狂野钓鱼",
						msg: "操作成功！",
						cbk: function() {
							window.location.href = WapSiteUrl + '/user/index.html';
						}
					});
					return false;
				} else {
					$(window).apptip({
						msg: result.error
					})

				}

			}
		});

	};

	//上传图片
	$('#pic').click(function() {
		// 上传方法
		$.upload({
			// 上传地址
			url: '/api/index/upload',
			// 文件域名字
			fileName: 'filedata',
			// 其他表单数据
			params: {
				up: 1,
				key: key
			},
			// 上传完成后, 返回json, text
			dataType: 'json',
			// 上传之后回调
			onComplate: function(data) {
				$('#imgshow').attr('src', data.datas).show();
				$('.add_pic').remove();
				$("input[name=user_icon]").val(data.datas);
			},
			// 上传之前回调,return true表示可继续上传
			onSend: function(e) {
				return true;
			}
		});
	})

})