//认领钓场
//http://www.fish.com/api.php/place/index/place_set
//POST['key'] = '1234'
//
//钓场详情
//http://www.fish.com/api.php/place/index/place_info
//GET['place_id'] = '1234'
//POST['key'] = '1234'

$(function() {
	var key = getcookie('key');
	//  if (key == '') {
	//      location.href = '/login.html';
	//  }
	var place_id = GetQueryString("place_id");

	$.ajax({
		url: ApiUrl + "/place/index/place_info",
		data: {
			place_id: place_id
		},
		timeout: '10000',
		error: function(a, b, c) {
			if (c != "error") {
				$(window).apptip({
					msg: c
				});
			} else {
				$(window).apptip({
					msg: "加载失败，请检查网络设置"
				});
			}
		},
		success: function(result) {
			var data = result.datas;
			var title = data.place.title;
			$("#title,title").text(title);
			var html = '';
			if (data == null) {
				location.href = '/404.html';
				return;
			}
			isok = true;
			$.each(data, function(k, v) {
				html += template.render(k, v);
			});
			$("#main-container").html(html);
			//话题图片等高
			$('.w_h').each(function() {
				$(this).height($(this).width());
			});
			//收藏事件
			set_like();
			
			//地图跳转
			$('#tomap').click(function(){
				$(window).apploading({msg:"跳转地图中，请稍后..."})
			})

			//评论事件
			$('#comment').click(function() {
				if (key == '') {
					$(window).appconfirm({
						msg: '您尚未登录，请登录后进行评论！',
						yes: function() {
							location.href = location.href = '/login.html';
						}
					});
				} else {
					var messages = $('#message').val();
					if (messages != '') {
						$.ajax({
							type: "post",
							url: ApiUrl + "/index/index/get_discuss_list",
							dataType: 'json',
							data: {
								id: place_id,
								key: key,
								type: 2,
								messages: messages
							},
							timeout: '10000',
							error: function(a, b, c) {
								if (c != "error") {
									$(window).apptip({
										msg: c
									});
								} else {
									$(window).apptip({
										msg: "加载失败，请检查网络设置"
									});
								}
							},
							success: function(result) {
								var data = result.datas;
								var comment_html = "";
								if (result.code == 1) {
									comment_html = template.render('discuss_list', data.discuss_list);
									$('#comment_list').remove();
									$('#comment_add').before(comment_html);
									$(window).appalert({
										tit: "操作提示",
										msg: "评论成功！"
									});
									$('#message').val('');
									var offset_top = $('#comment_list').offset().top;
									$('body,html').animate({
										scrollTop: offset_top - $('header').height()
									}, 300);
									return false;
								} else {
									$(window).apptip({
										msg: "请检查网络设置"
									})

								}

							}
						});
					} else {
						$(window).apptip({
							msg: "请输入评论内容"
						})
					}

				}
			})

            $('.emotion').qqFace({
                id: 'facebox',
                assign: 'message',
                path: '/static/arclist/' //表情存放的路径
            });
		}

	});

	function set_like() {
		$('#like').click(function() {
			if (key == '') {
				$(window).appconfirm({
					msg: '您尚未登录，请登录后进行评论！',
					yes: function() {
						location.href = location.href = '/login.html';
					}
				});
			} else {
				var likenum = $(this).attr('like');
				if (likenum == 0 || likenum == 2) {
					$.ajax({
						type: "post",
						url: ApiUrl + "/index/index/get_top_list",
						dataType: 'json',
						data: {
							id: place_id,
							key: "1234"
						},
						timeout: '10000',
						error: function(a, b, c) {
							if (c != "error") {
								$(window).apptip({
									msg: c
								});
							} else {
								$(window).apptip({
									msg: "加载失败，请检查网络设置"
								});
							}
						},
						success: function(result) {
							var data = result.datas;
							if (result.code == 1) {
								$('#like').attr({
									'like': 1
								});
								$('#like').removeClass('ticon-like');
								$('#like').addClass('ticon-likefill');
								$(window).apptip({
									msg: "收藏成功！"
								});
							} else {
								$(window).apptip({
									msg: "请检查网络设置"
								})
							}
						}
					});
				} else {
					$(window).apptip({
						msg: "您已经收藏过啦..."
					})
				}

			}
		})
	}

});