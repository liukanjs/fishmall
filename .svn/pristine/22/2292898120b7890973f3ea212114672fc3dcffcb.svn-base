<?php
namespace common\model;

use think\Model;

class MallGoods extends Model
{
    protected $type = [
        'create_time' => 'timestamp:Y/m/d H:i:s',
        'update_time' => 'timestamp:Y/m/d H:i:s'
    ];

    /**
     * TODO 获取商品列表
     *
     * @param $typeid
     * @param $goods_type
     * @param $order
     * @param $curpage
     * @param $page_size
     * @param array $search
     * @return array
     * @throws \think\exception\DbException
     */
    public function Goods_List($typeid, $goods_type, $order, $curpage, $page_size, $search = array())
    {
        $result = array();
        $model = $this->db();
        if ($typeid > 0) $model->where('typeid', 'eq', $typeid);
        switch ($goods_type) {
            case 0:
                break;
            case 1:
                $model->where('score_price', 'eq', 0);
                break;
            case 2:
                $model->where('score_price', 'neq', 0);
                break;
        }
        if (!empty($search['keyword'])) {
            $model->where('title', 'like', '%' . $search['keyword'] . '%');
        }
        $options = $model->getOptions();
        $num_rows = $model->count();
        trace($model->options($options)->buildSql(), 'sql');
		
		if($goods_type==2){
                $data_rows = $model->options($options)->order('score_price asc')->page($curpage, $page_size)->select();
        }else{
            if ($order == 'asc')
                $data_rows = $model->options($options)->order('id asc')->page($curpage, $page_size)->select();
            else
                $data_rows = $model->options($options)->order('id desc')->page($curpage, $page_size)->select();
        }

		
		
        foreach ($data_rows as $key => $value) {
            if (empty($value['img_list'])) {
                $data_rows[$key]['img'] = '/static/images/1-1.jpg';
            } else {
                $img = explode(',', $value['img_list']);
                $data_rows[$key]['img'] = $img[0];
            }
        }
        $result['data'] = $data_rows;
        $result['page'] = ceil($num_rows / $page_size);
        return $result;
    }
}