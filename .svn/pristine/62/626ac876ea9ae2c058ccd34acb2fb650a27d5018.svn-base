//钓场首页
//http://www.fish.com/api.php/place/index
//GET['type'] = 1,2,3,4
//GET['order'] = desc(9-0),asc(0-9)
//GET['city_id'] = 1024
//GET['keyword'] = 'yu'

$(function() {
	var isok = false;
	var main = "";
	var loadpage = 0;
	var keyword = GetQueryString('keyword');
	var key = getcookie('key');
	var lat = getcookie('lat');
	var lng = getcookie('lng');
	var city_name = unescape(getcookie('city_name'));
	var local_address=unescape(getcookie('address'));
	var city_id ="";
	
	//加载效果
	var listloading = $("<div class='text-center padding text-gray' id='listloading'><span class='ticon-loading icon-spin'></span> 加载中...</div>");
	var htmlDone = $('<div class="padding-big text-center text-gray" id="htmlDone">已经到底啦。。。</div>');



	//初始化城市定位
	if (GetQueryString('city_id') == "" || GetQueryString('city_id') == null) {
		$.ajax({
			url: "/static/js/plugins/citys/citys.json",
			type: 'post',
			data: 'json',
			timeout: '16000',
			error: function(a, b, c) {
				NProgress.done();
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				var data = result.datas;
				var citystr=city_name.substring(0,2);
				$(data).each(function(i, e) {
					var tcity=e.region_name;
					//console.log(e.region_name);
					if(tcity.match(citystr)!=null){
						city_id=e.region_id;
						$("input[name=city_id]").val(city_id);
						$('#city_val').attr('city_id',city_id);
						init();
					}
				});

			}
		});
	} else {
		 city_id = GetQueryString('city_id');
		$("input[name=city_id]").val(city_id);
		$('#city_val').attr('city_id',city_id);
		$.ajax({
			url: "/static/js/plugins/citys/citys.json",
			type: 'post',
			data: 'json',
			timeout: '16000',
			error: function(a, b, c) {
				NProgress.done();
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				var data = result.datas;
				$(data).each(function(i, e) {
					var tcity=e.region_name;
					if(e.region_id==city_id){
						$('#city_val').text(e.region_name);
						init();
					}
				});
			}
		});
	}


	//初始化列表内容
	function init() {
		var isok = false;
		$.ajax({
			url: ApiUrl + "/place/index",
			type: 'POST',
			data: {
				city_id: city_id,
				lat: lat,
				lng: lng
			},
			timeout: '16000',
			error: function(a, b, c) {
				NProgress.done();
				if (c != "error") {
					$(window).apptip({
						msg: c
					});
				} else {
					$(window).apptip({
						msg: "加载失败，请检查网络设置"
					});
				}
			},
			success: function(result) {
				NProgress.done();
				var data = result.datas;
				if (data == null) {
					location.href = '/404.html';
					return;
				}
				isok = true;
				//初始化页面
				var html = template.render("place_list", data);
				$("#main-container").html(html);
				$("input[name=hasmore]").val(result.hasmore);
				$("input[name=page_total]").val(result.page_total);

				order_list();

				setTimeout(function() {
					scrollLoad();
				}, 3000);

			}
		});
	}

	function order_list() {
		$('ul.wx-list-top>li').each(function() {
			$(this).click(function() {
				if($(this).attr('key')==1){
					$('ul.wx-list-top>li').removeClass('current');
					$(this).addClass('current');
					init();
					return;
				}
				
				if ($(this).attr('order') == "asc" && $(this).attr('class') == 'keyorder current') {
					$(this).attr('order', 'desc');
					$(this).find('span').removeClass('ticon-fold').addClass('ticon-fold');
					$("input[name=order]").val('desc');
				} else {
					$(this).attr('order', 'asc');
					$(this).find('span').removeClass('ticon-unfold').addClass('ticon-unfold');
					$("input[name=order]").val('asc');
				};

				$('ul.wx-list-top>li').removeClass('current');
				$(this).addClass('current');

				var order = $("input[name=order]").val();
				var type = $(this).attr('key');
				var city_id = $("input[name=city_id]").val();
				var api = ApiUrl + "/place/index/index?type=" + type + "&order=" + order +"&lat=" + lat +"&lng=" + lng + "&city_id=" + city_id + "&curpage=1&page_size=" + pagesize;
				$('#main-container').html('');
				$("input[name=type]").val(type);
				$("input[name=curpage]").val(1);
				
			

				$.ajax({
					url: api,
					type: 'get',
					timeout: '16000',
					error: function(a, b, c) {
						NProgress.done();
						if (c != "error") {
							$(window).apptip({
								msg: c
							});
						} else {
							$(window).apptip({
								msg: "加载失败，请检查网络设置"
							});
						}
					},
					success: function(result) {
						var data = result.datas;
						var htmls = '';
						if (data == null) {
							$(window).appalert({
								msg: "数据读取错误，请检查网络！"
							})
							return;
						}
						$("input[name=hasmore]").val(result.hasmore);
						$("input[name=page_total]").val(result.page_total);
						isok = true;

						//初始化页面
						var html = template.render("place_list", data);
						$("#main-container").html(html);

						$("#list_loading").hide();
						setTimeout(function() {
							scrollLoad();
						}, 1500)
					}
				});

			});
		});
	};

	//滚动加载
	function scrollLoad() {
		var _hght; //初始化滚动条总长
		$(window).scroll(function() {
			var dh = $(document).height(); //整个页面文档的高度
			var to_top = $(this).scrollTop(); //滚动条的高度
			var wh = $(this).height(); //窗口的高度；
			_hght = dh - to_top - wh; //滚动到底部的位置；
			//返回到顶部按钮
			if (to_top > wh) {
				$("#to-top").show();
			} else {
				$("#to-top").hide();
			};
		});

		var list_load = setInterval(function() {
			var dh = $(document).height(); //整个页面文档的高度
			var to_top = $(this).scrollTop(); //滚动条的高度
			var wh = $(this).height(); //窗口的高度；
			_hght = dh - to_top - wh; //滚动到底部的位置；
			if (_hght < ($(document).height() / 3)) {
				var hasmore = $('input[name=hasmore]').val();
				if (hasmore == "false") {
					clearInterval(list_load);
				} else if (hasmore == "true") {
					loadmoredata();
				};
			};
		}, 3000);
	};

	//滚动加载取值
	function loadmoredata() {
		var curpage = eval(parseInt($("input[name=curpage]").val()) + 1);
		var type = $('.keyorder.current').attr('key');
		var order = $('.keyorder.current').attr('order');
		var city_id = $("input[name=city_id]").val();
		var api = ApiUrl + "/place/index/index?type=" + type + "&order=" + order +"&lat=" + lat +"&lng=" + lng + "&city_id=" + city_id + "&curpage=" + curpage + "&page_size=" + pagesize;
		console.log(api);
		$("input[name=type]").val(type);
		$("input[name=order]").val(order);

		if (loadpage !== curpage) {
			loadpage = curpage;
			$.ajax({
				url: api,
				type: 'get',
				dataType: 'json',
			}).done(function(result) {
				var datas = result.datas;
				$("input[name=curpage]").val(curpage);
				$("input[name=hasmore]").val(result.hasmore);
				$("input[name=page_total]").val(result.page_total);

				var html = template.render("place_list", datas);
				$("#main-container").append(html);

				$("#list_loading").hide();

			}).fail(function(e) {}).always(function(e) {});
		}
	};

	//接口设置初始化
	function setListUrl() {
		$("input[name=hasmore]").val('');
		$("input[name=page_total]").val('');
		$("input[name=curpage]").val(1);
	};

});